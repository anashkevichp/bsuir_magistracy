\begin{figure}[tbp]
\centering
\includegraphics[scale=0.25]{rcu_data_callbacks.pdf}
\caption{Очередь callback'ов в \co{rcu_data}}
\label{fig:rcu_data_callbacks}
\end{figure}

\subsubsection{Callback'и RCU}
Структура \co{rcu_data} управляет RCU callback'ами, используя указатель
\co{->nxtlist}, указывающим на начало списка, и массив \co{->nxttail[]}
указателей-на-конец, формирующий четырехсегментный список
callback'ов~\cite{LaiJiangshan2008NewClassicAlgorithm},
где каждый элемент массива \co{->nxttail[]} указывает на конец
соответсвующего сегмента, как показано на рисунке~\ref{fig:rcu_data_callbacks}.
Сегмент, оканчивающийся на \co{->nxttail[RCU_DONE_TAIL]}
(<<\co{RCU_DONE_TAIL} сегмент>>), содержит готовые к вызову callback'и,
связанные с предыдущим grace-периодом.
Сегменты \co{RCU_WAIT_TAIL} и \co{RCU_NEXT_READY_TAIL}
содержат callback'и, ожидающие окончания текущего и следующего
grace-периодов, соответственно.
Наконец, сегмент \co{RCU_NEXT_TAIL} содержит callback'и,
которые еще не были связаны с каким-либо grace-периодом.
Поле \co{->qlen} выполняет учет общего числа callback'ов,
а \co{->blimit} определяет максимальное число callback'ов,
которые могут быть вызваны в данный момент времени, тем самым
ограничивая размер окна времени, используемого для их вызова,
на длинных списках callback'ов.\footnote{
  Вычислительные окружения реального времени, требующие выполнения
  более строгих ограничений времени вызова, должны использовать
  callback offloading, который находится вне контекста рассмотрения данной статьи.}

Возвращаясь к рисунку~\ref{fig:rcu_data_callbacks} отметим,
что элемент массива \co{->nxttail[RCU_DONE_TAIL]} указывает на \co{->nxtlist},
что означает, что в данный момент ни один из callback'ов не готов к вызову.
Элемент \co{->nxttail[RCU_WAIT_TAIL]} указывает на \co{->next}-указатель
второго callback'а, что означает, что callback'и CB~1 и CB~2 ожидают окончания данного
grace-периода.
Элемент \co{->nxttail[RCU_NEXT_READY_TAIL]} указывает на этот же
\co{->next}-указатель, что означает, что список не содержит callback'ов,
связанных со следующим grace-периодом.
Наконец, callback'и, расположенные между \co{->nxttail[RCU_NEXT_READY_TAIL]} и
\co{->nxttail[RCU_NEXT_TAIL]} элементами (CB~3 и CB~4),
еще не связаны ни с каким grace-периодом.
Элемент \co{->nxttail[RCU_NEXT_TAIL]} всегда указывает либо на последний callback,
либо, если весь список пустой, на \co{->nxtlist}.

Cache locality достигается за счет вызова callback'ов на тех вычислительных ядрах,
которые их зарегистрировали.
Например, примитив записи RCU \co{synchronize_rcu()} добавляет
callback \co{wakeme_after_rcu()} в конец списка \co{->nxttail[RCU_NEXT_TAIL]}
на данном вычислительном ядре (раздел \ref{sec:update_api_impl}).
По окончании данного grace-периода, которому соответствует изменение значения
поля \co{->completed} структуры \co{rcu_data}, меньшего, чем соответствующее значение
структуры \co{rcu_node}, они смещаются на один сегмент списка
(с помощью \co{rcu_advance_cbs()}).
Кроме этого, ядро процессора периодически объединяет сегменты \co{RCU_NEXT_TAIL}
и \co{RCU_NEXT_READY_TAIL} путем вызова \co{rcu_accelerate_cbs()}.
В некоторых специальных случаях, ядро выполняет объединение сегментов
\co{RCU_NEXT_TAIL} и \co{RCU_WAIT_TAIL}, пропуская сегмент \co{RCU_NEXT_TAIL}.
Эта оптимизация применяется в тех случаях, когда ядро начинает новый grace-период.
Она \emph{не} используется, когда ядро обнаруживает новый grace-период,
поскольку этот период мог начаться до момента добавления callback'ов
в сегмент \co{RCU_NEXT_TAIL}.

Это особенность архитектуры неслучайна: требование обеспечения
независимости работы вычислительных ядер
(для избегания исопльзования блокировок) является более важным,
чем сокращение продолжительности grace-периодов.
В тех редких случаях, когда требуются grace-периоды должны быть
максимально короткими, требуется использовать \co{synchronize_rcu_expedited()}.
Эта функция имеет такую же семантику, как и \co{synchronize_rcu()},
но предпочитает уменьшение задержки остальным оптимизациям.

Каждый RCU callback представляет собой структуру \co{rcu_head},
имеющую поле \co{->next}, указывающее на следующий callback в списке,
и поле \co{->func}, указывающее на функцию, подлежащую вызову
по окончаниии предстоящего grace-периода.
